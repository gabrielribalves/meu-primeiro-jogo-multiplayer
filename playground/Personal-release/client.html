<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meu Primeiro Game Multiplayer</title>
  <style>
    #tela{
      border: 10px solid #CCC;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      image-rendering: -moz-crisp-edges;
      width: 400px;
      height: 400px;
    }
  </style>
</head>
<body>
  <canvas id="tela" width="10" height="10"></canvas>

  <script>
    const canvasTela = document.querySelector('#tela')
    const context = tela.getContext('2d')
    const jogadorAtual = 'jogador1'

    
    function criarJogo(){
      const state = {
        jogadores: {}, 
        frutas: {}
      }

      function addJogador(comando){
        const jogadorId = comando.jogadorId
        const jogadorX = comando.jogadorX
        const jogadorY = comando.jogadorY

        state.jogadores[jogadorId] = {
          x: jogadorX,
          y: jogadorY
        }

      }
      function removeJogador(comando){
        const jogadorId = comando.jogadorId

        delete state.jogadores[jogadorId]
      }

      function addFruta(comando){
        const frutaId = comando.frutaId
        const frutaX = comando.frutaX
        const frutaY = comando.frutaY

        state.frutas[frutaId] = {
          x: frutaX,
          y: frutaY
        }

      }
      function removeFruta(comando){
        const frutaId = comando.frutaId

        delete state.frutas[frutaId]
      }

    function moverJogador(comando){
      const aceitarMovimentos = {
        ArrowUp(jogador){
          if(jogador.y - 1 >= 0){
            jogador.y -= 1;
          }
        },
        ArrowRight(jogador){
          if(jogador.x + 1 < tela.width){
            jogador.x += 1;
          }
        },
        ArrowDown(jogador){
          if(jogador.y + 1 < tela.height){
            jogador.y += 1;
          }          
        },
        ArrowLeft(jogador){
          if(jogador.x - 1 >= 0){
            jogador.x -= 1;
          }          
        },
      }

      const teclaPressionada = comando.teclaPressionada
      const jogadorId = comando.jogadorId
      const jogador = state.jogadores[jogadorId]
      const moverFunction = aceitarMovimentos[teclaPressionada]

      if(jogador && moverFunction){
        moverFunction(jogador)
        checkColisaoFruta(jogadorId)
      }
    }

    function checkColisaoFruta(jogadorId){
      const jogador = state.jogadores[jogadorId]

      for(const frutaId in state.frutas){
        const fruta = state.frutas[frutaId]
        console.log(`Checking ${jogadorId} and ${frutaId}`)

        if(jogador.x === fruta.x && jogador.y === fruta.y){
          console.log(`COLLISION between ${jogadorId} and ${frutaId}`);
          removeFruta({frutaId: frutaId})
        }
      }
    }
    return {
      addJogador,
      removeJogador, 
      addFruta,
      removeFruta,
      moverJogador,
      state
    }
  }

  const game = criarJogo()
  const keyboardListener = criarKeyboardListener()
  keyboardListener.subscribe(game.moverJogador)

  game.addJogador({jogadorId: 'jogador1', jogadorX: 0, jogadorY: 0})
  game.addJogador({jogadorId: 'jogador2', jogadorX: 2, jogadorY: 2})
  game.addJogador({jogadorId: 'jogador3', jogadorX: 3, jogadorY: 3})
  game.addFruta({frutaId: 'fruta1', frutaX: 3, frutaY: 4})
  game.addFruta({frutaId: 'fruta2', frutaX: 4, frutaY: 7})

  function criarKeyboardListener(){
    const state = {
      observers: []
    }

    function subscribe(observerFunction){
      state.observers.push(observerFunction)
    }

    function notifyAll(comando){
      for (const observerFunction of state.observers){
        observerFunction(comando)
      }
    }

    document.addEventListener('keydown', handleKeydown)
  
    function handleKeydown(event){
      const teclaPressionada = event.key
  
      const comando = {
        jogadorId: 'jogador1',
        teclaPressionada
      }
  
      notifyAll(comando);
    }

    return {
      subscribe
    }
  }


  renderTela()

  function renderTela(){
    context.fillStyle = 'white'
    context.clearRect(0, 0,10,10)

    for (const jogadorId in game.state.jogadores){
      const jogador = game.state.jogadores[jogadorId]
      context.fillStyle = 'black'
      context.fillRect(jogador.x, jogador.y, 1, 1)
    }

    for(const frutaId in game.state.frutas){
      const fruta = game.state.frutas[frutaId]
      context.fillStyle = 'green'
      context.fillRect(fruta.x, fruta.y, 1, 1)
    }

    requestAnimationFrame(renderTela)
  }
  // ----------------------------------------------------------------
  // document.addEventListener('keydown', handleKeydown)
  
  // function handleKeydown(event){
  //   const teclaPressionada = event.key

  //   const comando = {
  //     jogadorId: 'jogador1',
  //     teclaPressionada
  //   }
  // }
  // if(teclaPressionada === 'ArrowUp' && jogador.y - 1 >= 0){
  //   jogador.y -= 1;
  //   return
  // }
  // if(teclaPressionada === 'ArrowDown' && jogador.y + 1 < tela.height){
  //   jogador.y += 1;
  //   return
  // }
  // if(teclaPressionada === 'ArrowLeft' && jogador.x - 1 >= 0){
  //   jogador.x -= 1;
  //   return
  // }
  // if(teclaPressionada === 'ArrowRight' && jogador.x + 1 < tela.width){
  //   jogador.x += 1;
  //   return
  // }
  </script>
</body>
</html>